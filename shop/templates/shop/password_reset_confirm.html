<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <h2 class="text-2xl font-bold mb-6 text-center">Set New Password</h2>
        <form id="newPasswordForm" class="space-y-4">
            <div>
                <label for="new_password1" class="block mb-1 font-medium">New Password</label>
                <input type="password" id="new_password1" name="new_password1" required class="w-full px-3 py-2 border rounded-md">
            </div>
            <div>
                <label for="new_password2" class="block mb-1 font-medium">Confirm New Password</label>
                <input type="password" id="new_password2" name="new_password2" required class="w-full px-3 py-2 border rounded-md">
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition duration-300">
                Set New Password
            </button>
            <div id="error-message" class="text-red-500 text-center hidden"></div>
        </form>
    </div>

    <script>
        const axiosInstance = axios.create({
            baseURL: 'http://127.0.0.1:8000',
          });
          
          axiosInstance.interceptors.request.use(
            (config) => {
              const token = localStorage.getItem('accessToken');
              if (token) {
                config.headers['Authorization'] = `Bearer ${token}`;
              }
              return config;
            },
            (error) => {
              return Promise.reject(error);
            }
          );
          
          axiosInstance.interceptors.response.use(
            (response) => response,
            async (error) => {
              const originalRequest = error.config;
              if (error.response.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;
                try {
                  const refreshToken = localStorage.getItem('refreshToken');
                  const response = await axios.post('http://127.0.0.1:8000/api/token/refresh/', { refresh: refreshToken });
                  const { access } = response.data;
                  localStorage.setItem('accessToken', access);
                  originalRequest.headers['Authorization'] = `Bearer ${access}`;
                  return axiosInstance(originalRequest);
                } catch (refreshError) {
                  console.error('Error refreshing token:', refreshError);
                  localStorage.removeItem('accessToken');
                  localStorage.removeItem('refreshToken');
                  window.location.href = '/login';
                  return Promise.reject(refreshError);
                }
              }
              return Promise.reject(error);
            }
          );

        document.getElementById('newPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.add('hidden');

            const new_password1 = document.getElementById('new_password1').value;
            const new_password2 = document.getElementById('new_password2').value;
            
            // Extract uidb64 and token from the URL path instead of query parameters
            const pathParts = window.location.pathname.split('/');
            const uidb64 = pathParts[pathParts.indexOf('reset') + 1];
            const token = pathParts[pathParts.indexOf('reset') + 2];

            try {
                // Use the correct URL format matching your Django URL pattern
                const response = await axiosInstance.post(`/reset/${uidb64}/${token}/`, {
                    new_password1,
                    new_password2
                });
                
                // Redirect to the completion page using the correct URL from your Django URLs
                window.location.href = '/reset/done/';
            } catch (error) {
                console.error('Error:', error);
                errorDiv.textContent = error.response?.data?.message || 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>